<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Smart EHS Assistant</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root{
      --primary:#2563eb;--secondary:#64748b;--success:#10b981;--danger:#ef4444;--warning:#f59e0b;--info:#06b6d4
    }
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Helvetica Neue',sans-serif;background:#f8fafc;overflow:hidden}
    .app{display:flex;height:100%}
    .sidebar{width:280px;background:linear-gradient(180deg,#1e293b 0%,#334155 100%);color:#cbd5e1;display:flex;flex-direction:column;box-shadow:2px 0 10px rgba(0,0,0,0.1)}
    .sidebar h4{color:#fff;margin:0}
    .nav-item{display:block;color:#cbd5e1;text-decoration:none;padding:.75rem 1rem;border-left:3px solid transparent;transition:all 0.2s}
    .nav-item:hover{color:#fff;background:rgba(255,255,255,.08);border-left-color:var(--primary)}
    .nav-item.active{color:#fff;background:rgba(37,99,235,.18);border-left-color:var(--primary)}
    .chat{flex:1;display:flex;flex-direction:column;background:#fff}
    .chat-header{padding:1rem 1.5rem;border-bottom:1px solid #e5e7eb;display:flex;justify-content:between;align-items:center;background:linear-gradient(135deg,var(--primary),#3b82f6);color:white}
    .chat-messages{flex:1;overflow:auto;background:#f9fafb;padding:1.25rem}
    .message{margin-bottom:1.5rem;animation:fadeIn .3s ease}
    .message .hdr{display:flex;align-items:center;gap:.5rem;margin-bottom:.5rem}
    .avatar{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:.85rem}
    .avatar.user{background:linear-gradient(135deg,var(--success),#059669)}
    .avatar.ai{background:linear-gradient(135deg,var(--primary),#3b82f6)}
    .time{margin-left:auto;color:#9ca3af;font-size:.75rem}
    .content{margin-left:2.6rem;line-height:1.6;color:#374151}
    .chat-input{padding:1rem 1.25rem;border-top:1px solid #e5e7eb;background:#fff}
    .input-wrap{display:flex;gap:.75rem;align-items:flex-end;max-width:1000px;margin:0 auto}
    .field{flex:1;border:2px solid #e5e7eb;border-radius:1rem;min-height:56px;max-height:180px;resize:none;padding:.875rem 1rem;font-size:1rem}
    .field:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(37,99,235,.1)}
    .icon-btn,.send-btn{width:48px;height:48px;border-radius:.75rem;border:0;display:flex;align-items:center;justify-content:center;color:#fff;cursor:pointer;transition:all 0.2s}
    .icon-btn{background:var(--secondary)}
    .icon-btn:hover{background:#475569;transform:translateY(-1px)}
    .send-btn{background:var(--primary)}
    .send-btn:hover{background:#1d4ed8;transform:translateY(-1px)}
    .send-btn:disabled{background:#9ca3af;cursor:not-allowed}
    .file-input{display:none}
    .quick{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1.25rem;max-width:1000px;margin:2rem auto}
    .card.quick-card{cursor:pointer;border:1px solid #e5e7eb;transition:all 0.3s;background:white}
    .card.quick-card:hover{transform:translateY(-3px);box-shadow:0 8px 25px rgba(0,0,0,.15);border-color:var(--primary)}
    .quick-card .card-body{padding:1.5rem}
    .quick-card-icon{font-size:2rem;margin-bottom:1rem}
    .stat{padding:1rem;border-top:1px solid rgba(255,255,255,.1);background:rgba(0,0,0,.18)}
    .stat .rowx{display:flex;justify-content:space-between;padding:.4rem 0;font-size:0.9rem}
    .welcome-section{text-align:center;padding:3rem 2rem}
    .welcome-title{font-size:2.5rem;font-weight:700;background:linear-gradient(135deg,var(--primary),#3b82f6);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:1rem}
    .welcome-subtitle{font-size:1.25rem;color:#64748b;margin-bottom:2rem}
    .feature-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:1.5rem;margin-top:2rem}
    .feature-card{background:white;border-radius:1rem;padding:2rem;border:1px solid #e5e7eb;transition:all 0.3s}
    .feature-card:hover{transform:translateY(-2px);box-shadow:0 10px 40px rgba(0,0,0,.1)}
    .typing-indicator{display:none;margin-bottom:1rem}
    .typing-dots{display:flex;gap:4px;margin-left:2.6rem}
    .typing-dots span{width:8px;height:8px;border-radius:50%;background:#6b7280;animation:typing 1.4s infinite ease-in-out}
    .typing-dots span:nth-child(1){animation-delay:-0.32s}
    .typing-dots span:nth-child(2){animation-delay:-0.16s}
    .quick-replies{display:flex;flex-wrap:wrap;gap:0.5rem;margin-top:1rem;margin-left:2.6rem}
    .quick-reply{background:rgba(37,99,235,0.1);border:1px solid var(--primary);color:var(--primary);padding:0.5rem 1rem;border-radius:1rem;font-size:0.9rem;cursor:pointer;transition:all 0.2s}
    .quick-reply:hover{background:var(--primary);color:white;transform:translateY(-1px)}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:none}}
    @keyframes typing{0%,80%,100%{transform:scale(0.8);opacity:0.5}40%{transform:scale(1);opacity:1}}
    @media(max-width:768px){
      .sidebar{position:absolute;inset:0 auto 0 0;transform:translateX(-100%);transition:.25s;z-index:1000}
      .sidebar.open{transform:none}
      .chat{width:100%}
      .welcome-title{font-size:2rem}
      .quick{grid-template-columns:1fr}
      .input-wrap{flex-wrap:wrap;gap:0.5rem}
      .field{min-height:48px;margin-bottom:0.5rem}
    }
  </style>
</head>
<body>
<div class="app">
  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="p-3 border-bottom border-white border-opacity-10">
      <h4><i class="bi bi-shield-check me-2"></i>Smart EHS</h4>
      <small class="text-white-50">Your AI Safety Assistant</small>
    </div>
    
    <div class="p-2 small text-uppercase text-white-50 fw-bold">Navigation</div>
    <a class="nav-item active" href="/"><i class="bi bi-robot me-2"></i>AI Assistant</a>
    <a class="nav-item" href="/dashboard"><i class="bi bi-graph-up me-2"></i>Analytics Dashboard</a>

    <div class="p-2 small text-uppercase text-white-50 mt-3 fw-bold">Safety Management</div>
    <a class="nav-item" href="/incidents"><i class="bi bi-exclamation-triangle me-2"></i>Incidents</a>
    <a class="nav-item" href="/safety-concerns"><i class="bi bi-shield-exclamation me-2"></i>Safety Concerns</a>
    <a class="nav-item" href="/risk/register"><i class="bi bi-graph-up-arrow me-2"></i>Risk Register</a>

    <div class="p-2 small text-uppercase text-white-50 mt-3 fw-bold">Operations</div>
    <a class="nav-item" href="/capa"><i class="bi bi-arrow-repeat me-2"></i>CAPAs</a>
    <a class="nav-item" href="/audits"><i class="bi bi-clipboard-check me-2"></i>Audits</a>
    <a class="nav-item" href="/sds"><i class="bi bi-file-earmark-text me-2"></i>SDS Library</a>
    <a class="nav-item" href="/contractors"><i class="bi bi-people me-2"></i>Contractors</a>

    <!-- Live Stats -->
    <div class="stat mt-auto">
      <div class="text-white-50 small mb-2 fw-bold">Live Status</div>
      <div class="rowx"><span>Open Incidents</span><b id="openIncidents">-</b></div>
      <div class="rowx"><span>Overdue CAPAs</span><b id="overdueCapas">-</b></div>
      <div class="rowx"><span>Safety Concerns</span><b id="safetyConcerns">-</b></div>
      <div class="rowx">
        <span>System Status</span>
        <b class="text-success" id="sysStatus">
          <i class="bi bi-circle-fill" style="font-size:0.6rem"></i> Online
        </b>
      </div>
    </div>
  </aside>

  <!-- Main Chat Interface -->
  <main class="chat">
    <div class="chat-header">
      <div class="d-flex align-items-center gap-3">
        <button class="btn btn-light d-md-none" id="menuBtn">
          <i class="bi bi-list"></i>
        </button>
        <div class="avatar ai">
          <i class="bi bi-robot"></i>
        </div>
        <div>
          <div class="fw-bold fs-5">Smart EHS Assistant</div>
          <div class="opacity-75">Your intelligent Environmental, Health & Safety companion</div>
        </div>
      </div>
      <div class="d-flex align-items-center gap-2">
        <span class="badge bg-success bg-opacity-25 text-white">
          <i class="bi bi-circle-fill me-1" style="font-size:.5rem"></i>Online
        </span>
        <button class="btn btn-light btn-sm" onclick="resetChat()">
          <i class="bi bi-arrow-clockwise"></i> Reset
        </button>
      </div>
    </div>

    <div class="chat-messages" id="chat">
      <!-- Welcome Section -->
      <section id="welcome" class="welcome-section">
        <div class="welcome-title">
          <i class="bi bi-robot me-3"></i>Welcome to Smart EHS
        </div>
        <p class="welcome-subtitle">
          Your AI-powered Environmental, Health & Safety management system. 
          Report incidents, assess risks, manage safety concerns, and more with intelligent assistance.
        </p>
        
        <div class="quick">
          <div class="card quick-card" onclick="sendMessage('I need to report a workplace incident')">
            <div class="card-body text-center">
              <div class="quick-card-icon text-danger">üö®</div>
              <h5 class="card-title">Report Incident</h5>
              <p class="card-text text-muted">Guided incident reporting with AI assistance</p>
            </div>
          </div>
          
          <div class="card quick-card" onclick="sendMessage('I want to submit a safety concern')">
            <div class="card-body text-center">
              <div class="quick-card-icon text-warning">üõ°Ô∏è</div>
              <h5 class="card-title">Safety Concern</h5>
              <p class="card-text text-muted">Report near misses and unsafe conditions</p>
            </div>
          </div>
          
          <div class="card quick-card" onclick="sendMessage('Help me conduct a risk assessment')">
            <div class="card-body text-center">
              <div class="quick-card-icon text-info">üìä</div>
              <h5 class="card-title">Risk Assessment</h5>
              <p class="card-text text-muted">ERC matrix and likelihood analysis</p>
            </div>
          </div>
          
          <div class="card quick-card" onclick="sendMessage('I need to find a safety data sheet')">
            <div class="card-body text-center">
              <div class="quick-card-icon text-success">üìã</div>
              <h5 class="card-title">Find SDS</h5>
              <p class="card-text text-muted">Search safety data sheets with citations</p>
            </div>
          </div>
          
          <div class="card quick-card" onclick="sendMessage('Show me urgent tasks and overdue items')">
            <div class="card-body text-center">
              <div class="quick-card-icon text-primary">‚ö°</div>
              <h5 class="card-title">Priority Items</h5>
              <p class="card-text text-muted">Overdue CAPAs and urgent tasks</p>
            </div>
          </div>
          
          <div class="card quick-card" onclick="sendMessage('Help me get started with the EHS system')">
            <div class="card-body text-center">
              <div class="quick-card-icon text-secondary">üéØ</div>
              <h5 class="card-title">System Guide</h5>
              <p class="card-text text-muted">Feature walkthrough and training</p>
            </div>
          </div>
        </div>
        
        <div class="mt-4 text-muted">
          <small>üí° <strong>Tip:</strong> Just type what you need help with, like "report injury" or "find acetone SDS"</small>
        </div>
      </section>
    </div>

    <!-- Typing Indicator -->
    <div class="typing-indicator" id="typingIndicator">
      <div class="typing-dots">
        <span></span><span></span><span></span>
      </div>
    </div>

    <!-- Chat Input -->
    <div class="chat-input">
      <form id="chatForm" onsubmit="return false;">
        <div class="input-wrap">
          <textarea id="msg" class="field" rows="1" placeholder="Ask me anything about EHS... (e.g., 'Report incident', 'Find SDS for acetone', 'What needs my attention?')"></textarea>
          <button class="icon-btn" type="button" id="fileBtn" title="Attach file">
            <i class="bi bi-paperclip"></i>
          </button>
          <button class="send-btn" type="submit" id="sendBtn" title="Send message">
            <i class="bi bi-send"></i>
          </button>
          <input id="file" class="file-input" type="file" accept="image/*,.pdf,.txt">
        </div>
      </form>
      <div id="filePreview" class="small text-muted mt-2 d-none"></div>
    </div>
  </main>
</div>

<script>
  // State management
  let historyBuf = [];
  let waiting = false;
  let selFile = null;

  // DOM helpers
  const $ = (s) => document.querySelector(s);
  const chat = $('#chat');
  const msg = $('#msg');
  const file = $('#file');
  const fileBtn = $('#fileBtn');
  const sendBtn = $('#sendBtn');
  const menuBtn = $('#menuBtn');
  const welcome = $('#welcome');

  function timeNow() { 
    return new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); 
  }

  function addMessage(who, text, actions = null) {
    // Hide welcome section when first message is sent
    if (welcome) {
      welcome.style.display = 'none';
    }

    const wrap = document.createElement('div');
    wrap.className = 'message';
    
    let actionButtons = '';
    if (actions && actions.length > 0) {
      actionButtons = '<div class="quick-replies">';
      actions.forEach(action => {
        actionButtons += `<button class="quick-reply" onclick="sendMessage('${action.replace(/'/g, "\\'")}')">${action}</button>`;
      });
      actionButtons += '</div>';
    }
    
    wrap.innerHTML = `
      <div class="hdr">
        <div class="avatar ${who === 'user' ? 'user' : 'ai'}">
          ${who === 'user' ? '<i class="bi bi-person"></i>' : '<i class="bi bi-robot"></i>'}
        </div>
        <div class="fw-semibold">${who === 'user' ? 'You' : 'EHS Assistant'}</div>
        <div class="time">${timeNow()}</div>
      </div>
      <div class="content">${formatMessage(text || '')}</div>
      ${actionButtons}
    `;
    
    chat.appendChild(wrap);
    chat.scrollTop = chat.scrollHeight;
  }

  function formatMessage(text) {
    const escaped = String(text).replace(/[&<>"']/g, m => ({
      '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
    }[m]));
    
    return escaped
      .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
      .replace(/\*(.*?)\*/g, '<em>$1</em>')
      .replace(/`([^`]+)`/g, '<code class="bg-light px-1 rounded">$1</code>')
      .replace(/\n/g, '<br>');
  }

  function showTyping() {
    $('#typingIndicator').style.display = 'block';
    chat.scrollTop = chat.scrollHeight;
  }

  function hideTyping() {
    $('#typingIndicator').style.display = 'none';
  }

  function setEnabled(enabled) {
    waiting = !enabled;
    sendBtn.disabled = !enabled;
    msg.disabled = !enabled;
    if (enabled) msg.focus();
  }

  function sendMessage(text) {
    if (text) {
      msg.value = text;
    }
    sendBtn.click();
  }

  async function sendUserMessage() {
    const userMessage = msg.value.trim();
    
    if (!userMessage && !selFile) return;
    
    // Add user message
    addMessage('user', userMessage || `üìé ${selFile?.name || 'file'}`);
    setEnabled(false);
    showTyping();

    // Prepare form data
    const formData = new FormData();
    if (userMessage) formData.append('message', userMessage);
    formData.append('user_id', 'main_chat_user');
    formData.append('context', JSON.stringify({
      from: 'enhanced_dashboard',
      timestamp: Date.now(),
      history: historyBuf.slice(-5)
    }));
    if (selFile) formData.append('file', selFile);

    try {
      const response = await fetch('/chat', {
        method: 'POST',
        body: formData
      });
      
      const data = await response.json();
      hideTyping();
      
      // Add AI response with quick replies
      addMessage('ai', data.message || 'I received your message.', data.quick_replies || []);
      
      // Store in history
      historyBuf.push({
        user: userMessage,
        ai: data.message,
        timestamp: Date.now()
      });
      
      if (historyBuf.length > 20) {
        historyBuf = historyBuf.slice(-10);
      }
      
    } catch (error) {
      hideTyping();
      addMessage('ai', "I'm having trouble connecting right now. Please try again in a moment.");
      console.error('Chat error:', error);
    }
    
    // Reset form
    setEnabled(true);
    msg.value = '';
    selFile = null;
    file.value = '';
    showFilePreview();
  }

  function showFilePreview() {
    const preview = $('#filePreview');
    if (!selFile) {
      preview.classList.add('d-none');
      preview.textContent = '';
      return;
    }
    preview.textContent = `üìé Attached: ${selFile.name} (${Math.ceil(selFile.size/1024)} KB)`;
    preview.classList.remove('d-none');
  }

  function validateFile(file) {
    if (!file) return false;
    if (file.size > 16*1024*1024) {
      toast('File too large (max 16MB)', 'danger');
      return false;
    }
    const allowed = ['image/jpeg', 'image/png', 'image/gif', 'application/pdf', 'text/plain'];
    if (!allowed.includes(file.type)) {
      toast('Unsupported file type. Use images, PDF, or text files.', 'danger');
      return false;
    }
    return true;
  }

  async function resetChat() {
    historyBuf = [];
    selFile = null;
    msg.value = '';
    file.value = '';
    $('#filePreview').classList.add('d-none');
    chat.innerHTML = '';
    welcome.style.display = 'block';
    
    try {
      await fetch('/chat/reset', { method: 'POST' });
    } catch (error) {
      console.error('Reset error:', error);
    }
    
    addMessage('ai', "üëã Hello! I'm your Smart EHS Assistant. How can I help you today?");
  }

  async function refreshStats() {
    try {
      const response = await fetch('/api/stats');
      if (!response.ok) throw new Error('Failed to fetch stats');
      
      const data = await response.json();
      $('#openIncidents').textContent = data.incidents?.open || 0;
      $('#overdueCapas').textContent = data.capas?.overdue || 0;
      $('#safetyConcerns').textContent = data.safety_concerns?.open || 0;
      $('#sysStatus').innerHTML = '<i class="bi bi-circle-fill" style="font-size:0.6rem"></i> Online';
      $('#sysStatus').className = 'text-success';
    } catch (error) {
      $('#sysStatus').innerHTML = '<i class="bi bi-circle-fill" style="font-size:0.6rem"></i> Offline';
      $('#sysStatus').className = 'text-danger';
      console.error('Stats error:', error);
    }
  }

  function toast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} position-fixed`;
    toast.style.cssText = 'top:20px;right:20px;z-index:9999;min-width:300px';
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 4000);
  }

  // Event listeners
  document.addEventListener('DOMContentLoaded', () => {
    addMessage('ai', "üëã **Welcome to Smart EHS!** I'm here to help you with incident reporting, safety concerns, risk assessments, SDS lookup, and more. What would you like to do?");
    refreshStats();
    setInterval(refreshStats, 30000);

    // Auto-resize textarea
    msg.addEventListener('input', () => {
      msg.style.height = 'auto';
      msg.style.height = Math.min(msg.scrollHeight, 180) + 'px';
    });

    // Enter to send (Shift+Enter for new line)
    msg.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendUserMessage();
      }
    });

    // Form submission
    $('#chatForm').addEventListener('submit', (e) => {
      e.preventDefault();
      sendUserMessage();
    });

    // File handling
    fileBtn.addEventListener('click', () => file.click());
    file.addEventListener('change', (e) => {
      const selectedFile = e.target.files[0];
      if (validateFile(selectedFile)) {
        selFile = selectedFile;
        showFilePreview();
      } else {
        file.value = '';
        selFile = null;
        showFilePreview();
      }
    });

    // Mobile menu
    if (menuBtn) {
      menuBtn.addEventListener('click', () => {
        $('#sidebar').classList.toggle('open');
      });
    }

    // Focus message input
    msg.focus();
  });
</script>
</body>
</html>
